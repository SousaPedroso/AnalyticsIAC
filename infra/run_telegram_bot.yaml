- name: Setup Telegran
  hosts: telegram-bot
  become: true
  tasks:
    - name: Create application directory
      ansible.builtin.file:
        path: /srv/app/
        state: directory
        mode: '0755'

    - name: Pull repository
      ansible.builtin.unarchive:
        src: https://github.com/donBarbos/telegram-bot-template/archive/main.zip
        dest: /srv/app/
        remote_src: yes

    - name: Setup Environment variables
      ansible.builtin.copy:
        content: |
          BOT_TOKEN = "{{ bot_token }}"
          DB_HOST = "{{ db_host }}"
          DB_PORT = "{{ db_port }}"
          DB_USER = "{{ db_user }}"
          DB_PASS = "{{ db_pass }}"
          DB_NAME = "{{ db_name }}"
          REDIS_HOST = "{{ redis_host }}"
          REDIS_PORT = "{{ redis_port }}"
          REDIS_PASS = "{{ redis_pass }}"
          WEBHOOK_PORT = "{{ webhook_port }}"
          PROMETHEUS_PORT = "{{ prometheus_port }}"
          GRAFANA_PORT = "{{ grafana_port }}"
          GRAFANA_ADMIN_USER = "{{ grafana_admin_user }}"
          GRAFANA_ADMIN_PASSWORD = "{{ grafana_admin_pass }}"
          ADMIN_PORT = "{{ admin_port }}"
        dest: /srv/app/telegram-bot-template-main/.env
        mode: '0644'

    - name: Tear down existing services
      community.docker.docker_compose_v2:
        project_src: /srv/app/telegram-bot-template-main/
        state: absent

    - name: Instantiate bot
      community.docker.docker_compose_v2:
        project_src: /srv/app/telegram-bot-template-main/
        state: present